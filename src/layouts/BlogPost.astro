---
import type { MarkdownHeading } from 'astro'
import type { CollectionEntry } from 'astro:content'

// Plugin styles
import 'katex/dist/katex.min.css'

import { Comment, MediumZoom } from 'astro-pure/advanced'
import { ArticleBottom, Copyright, Hero, TOC } from 'astro-pure/components/pages'
import PageLayout from '@/layouts/ContentLayout.astro'
import { integ } from '@/site-config'

interface Props {
  post: CollectionEntry<'blog'>
  posts: CollectionEntry<'blog'>[]
  headings: MarkdownHeading[]
  remarkPluginFrontmatter: Record<string, unknown>
}

const {
  post: { id, data },
  posts,
  headings,
  remarkPluginFrontmatter
} = Astro.props

const {
  description,
  heroImage,
  publishDate,
  title,
  updatedDate,
  draft: isDraft,
  comment: enableComment
} = data

const socialImage = heroImage
  ? typeof heroImage.src === 'string'
    ? heroImage.src
    : heroImage.src.src
  : '/images/social-card.png'
const articleDate = updatedDate?.toISOString() ?? publishDate.toISOString()
const primaryColor = data.heroImage?.color ?? 'hsl(var(--primary) / var(--un-text-opacity))'
---

<PageLayout
  meta={{ articleDate, description, ogImage: socialImage, title }}
  highlightColor={primaryColor}
  back='/blog'
>
  {!!headings.length && <TOC {headings} slot='sidebar' />}

  <!-- 添加自定义类名用于样式定位 -->
  <Hero 
    {data} 
    {remarkPluginFrontmatter} 
    slot='header' 
    class="custom-hero" 
  />

  <slot />

  <Fragment slot='bottom'>
    <Copyright {data} />
    <ArticleBottom collections={posts} {id} class='mt-3 sm:mt-6' />
    {!isDraft && enableComment && <Comment class='mt-3 sm:mt-6' />}
  </Fragment>

  <slot name='bottom-sidebar' slot='bottom-sidebar' />
</PageLayout>

{integ.mediumZoom.enable && <MediumZoom />}

<!-- 关键：强制覆盖封面图片样式 -->
<style is:global>
  /* 1. 定位Hero组件内的图片容器 */
  .custom-hero .hero-image,  /* 常见的图片容器类名 */
  .custom-hero .hero-img,
  .custom-hero [data-hero-image] {
    /* 固定比例（16:9），可修改为 4:3、2:1 等 */
    aspect-ratio: 16 / 9 !important; 
    width: 100% !important;
    max-width: 100% !important;
    overflow: hidden !important;
    position: relative !important;
  }

  /* 2. 强制图片裁切规则 */
  .custom-hero .hero-image img,
  .custom-hero .hero-img img,
  .custom-hero [data-hero-image] img,
  .custom-hero img[alt="Hero image"] {  /* 针对图片本身 */
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important; /* 核心：保持比例并裁切 */
    object-position: center !important; /* 裁切时保留中心区域 */
    /* 取消可能的默认限制 */
    max-width: none !important;
    max-height: none !important;
  }
</style>
